# Repository Guidelines

## Project Structure & Module Organization
Root holds the manifest plus the domain-specific docs (`README.md`, `AGENTS.md`, `HANDOFF.md`). The Chrome extension lives under `extension/` with `content/` for injected scripts, `ui/` for popup/options surfaces, and `background.js` for the service worker that drives auto-scan. The Flask API sits in `backend/` (`backend/app.py`, `backend/requirements.txt`) and now writes feedback into `backend/reports.db`; it reuses TLS cert/key files under `~/.finalextension/`. Screenshots and generated artifacts stay out of git via `.gitignore`.

## Build, Test, and Development Commands
Install extension deps with `npm install`; backend deps with `pip install -r backend/requirements.txt` (installs Flask-CORS, pyOpenSSL, transformers, optimum[onnxruntime]; PyTorch is optional for GPU execution). Build via `npm run build`. For iterative work run `npm run dev` and `npx web-ext run --source-dir dist`. Before starting the API, prefer generating trusted localhost certs with `mkcert`:

```bash
mkdir -p ~/.finalextension/mkcert
mkcert -install
mkcert -cert-file ~/.finalextension/mkcert/localhost.pem \
       -key-file ~/.finalextension/mkcert/localhost-key.pem \
       localhost 127.0.0.1 ::1
export SENTINEL_CERT_FILE="$HOME/.finalextension/mkcert/localhost.pem"
export SENTINEL_KEY_FILE="$HOME/.finalextension/mkcert/localhost-key.pem"
python backend/app.py
```

If `SENTINEL_CERT_FILE`/`SENTINEL_KEY_FILE` are set and exist, the server uses them; otherwise it mints self-signed cert/key files in `~/.finalextension/` and serves `https://localhost:5000/predict`. When falling back to the autogenerated cert, import `~/.finalextension/localhost-cert.pem` into Keychain Access and mark it “Always Trust” before testing in Chrome to avoid the “Not Secure” warning. Manifest host permissions include both HTTPS (primary) and HTTP (fallback for local http pages). Run `npx web-ext lint` before PRs.

## Coding Style & Naming Conventions
Use TypeScript or modern ES modules in the extension with 2-space indentation, single quotes, and kebab-case filenames (`content-router.ts`). Classes stay PascalCase, exported functions camelCase. Backend code follows PEP 8, 4-space indentation, snake_case helpers, and docstrings on Flask routes—keep modules under `backend/`. Run `npm run lint` and keep `manifest.json` keys alphabetized. Maintain popup/options assets in `extension/ui/` and content scripts in `extension/content/`; `popup.js` manages tab injection plus manual text analysis, the scan trigger, sensitivity slider, highlight-style selector, feedback queue/history views, and the auto-scan toggle (which requests host permissions). `background.js` listens for navigation events and injects the scanner when auto-scan is active. `extension/content/content.js` splits blocks into sentences, batches calls to `/predict/batch`, dedupes flagged spans so each snippet gets a single control set, wraps only the flagged text spans (style-aware), and renders feedback controls tied to those snippets—feedback posts to `/report` with retry/backoff, queues offline requests in `chrome.storage.local`, and logs activity for auditing.

## Testing Guidelines
Use Vitest or Jest for extension units and Playwright for popup/content flows. Name test files `<module>.spec.ts` or `<module>.test.ts` under `tests/`. For the API, add pytest suites in `tests/api/test_predict.py`, covering happy path, validation failures, GPU/CPU fallbacks, `/predict/batch`, and `/report` persistence in `backend/reports.db`. Target ≥80% statement coverage via `npm run test -- --coverage` and `pytest --cov`; note any gaps in the PR. Run manual smoke checks on social feeds to confirm mutation rescans highlight new posts, tooltip buttons behave, the popup status indicator responds to `scan-start`/`scan-progress`/`scan-complete`, user-selected highlight styles render as expected, `/report` accepts feedback, CORS preflights succeed, and HTTPS calls to `https://localhost:5000/predict` work once the cert is trusted (HTTP fallback only for local http pages).
Verify the feedback queue by simulating offline mode, ensuring reports are queued, pending counts reflect storage, and queued entries flush successfully when connectivity returns. When auto-scan is enabled, confirm permissions are granted, new tabs automatically inject the scanner without manual clicks, and turning the toggle off stops further injections.

## Commit & Pull Request Guidelines
History remains clean—adhere to Conventional Commits (`feat:`, `fix:`, `chore:`) for traceability. Each PR must include: linked issue, summary of extension and API changes, verification steps (`npm run build`, `npx web-ext lint`, `python backend/app.py`, relevant tests), and screenshots or gifs for UI updates. Confirm host permission changes (e.g., `http://localhost:5000/*`) in the PR description. Request review only after lint suites and automated tests pass.

Refer to `CONTRIBUTING.md` for the full workflow and to `.github/ISSUE_TEMPLATE/` for required issue formats. All contributors must follow the project `CODE_OF_CONDUCT.md`.
